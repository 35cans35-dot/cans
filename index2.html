<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>TrailCompass</title>
<style>
  :root{--bg:#0d1117;--card:#161b22;--fg:#e6edf3;--muted:#8b949e;--acc:#2f81f7;--ok:#2ea043;--bad:#f85149;}
  body{margin:0;background:var(--bg);color:var(--fg);font:14px/1.4 system-ui,Segoe UI,Roboto,Arial}
  header{display:flex;gap:8px;align-items:center;padding:12px 16px;border-bottom:1px solid #21262d}
  h1{font-size:16px;margin:0 8px 0 0;color:var(--muted)}
  button{background:var(--acc);color:#fff;border:0;border-radius:10px;padding:8px 12px;cursor:pointer}
  button.secondary{background:#30363d}
  .wrap{max-width:760px;margin:0 auto;padding:16px;display:grid;gap:12px}
  .grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:12px}
  .card{background:var(--card);border:1px solid #21262d;border-radius:12px;padding:12px}
  .label{color:var(--muted);font-size:12px;margin-bottom:4px}
  .val{font-size:20px}
  .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
  input[type="text"]{background:#0b0f14;color:var(--fg);border:1px solid #30363d;border-radius:10px;padding:8px;width:140px}
  .pill{display:inline-block;padding:4px 8px;border-radius:999px;font-size:12px}
  .ok{background:rgba(46,160,67,.15);color:var(--ok);border:1px solid rgba(46,160,67,.4)}
  .bad{background:rgba(248,81,73,.15);color:var(--bad);border:1px solid rgba(248,81,73,.4)}
  .muted{color:var(--muted)}
  .mono{font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace}
  .foot{color:var(--muted);font-size:12px;text-align:center;margin-top:8px}
</style>
</head>
<body>
<header>
  <h1>TrailCompass</h1>
  <button id="btnConnect">Connect</button>
  <span id="connState" class="muted">disconnected</span>
</header>

<div class="wrap">
  <div class="grid">
    <div class="card"><div class="label">GPS Fix</div><div class="val" id="fix"><span class="pill bad">NO FIX</span></div></div>
    <div class="card"><div class="label">SAT / HDOP</div><div class="val"><span id="sats">--</span> / <span id="hdop">--</span></div></div>
    <div class="card"><div class="label">ALT (m)</div><div class="val" id="alt">--</div></div>
    <div class="card"><div class="label">Speed (km/h)</div><div class="val" id="spd">--</div></div>
    <div class="card"><div class="label">Course (°)</div><div class="val" id="cog">--</div></div>
    <div class="card"><div class="label">DIST</div><div class="val" id="dist">--</div></div>
    <div class="card"><div class="label">BRG (°)</div><div class="val" id="brg">--</div></div>
    <div class="card"><div class="label">Target</div><div class="val" id="tgt"><span class="pill bad">OFF</span></div></div>
  </div>

  <div class="card">
    <div class="label">Current position</div>
    <div class="mono" id="pos">lat=-- lon=--</div>
  </div>

  <div class="card">
    <div class="label">Set target</div>
    <div class="row">
      <input id="tLat" type="text" placeholder="lat (e.g. 52.319259)">
      <input id="tLon" type="text" placeholder="lon (e.g. 104.493283)">
      <button id="btnSet">Set</button>
      <button id="btnClear" class="secondary">Clear</button>
      <button id="btnGet" class="secondary">GET</button>
      <button id="btnR500" class="secondary">Rate 500ms</button>
      <button id="btnR1000" class="secondary">Rate 1s</button>
    </div>
  </div>

  <div class="card">
    <div class="label">Log</div>
    <div id="log" class="mono" style="white-space:pre-wrap;max-height:240px;overflow:auto;"></div>
  </div>

  <div class="foot">Works over Web Bluetooth (NUS). Tested in Chrome / Android.</div>
</div>

<script>
const NUS_SERVICE   = '6e400001-b5a3-f393-e0a9-e50e24dcca9e';
const NUS_RX_CHAR   = '6e400002-b5a3-f393-e0a9-e50e24dcca9e';
const NUS_TX_CHAR   = '6e400003-b5a3-f393-e0a9-e50e24dcca9e';

let device, server, svc, rx, tx;

function log(s){
  const el = document.getElementById('log');
  el.textContent += s + '\n';
  el.scrollTop = el.scrollHeight;
}
function setConnState(s){ document.getElementById('connState').textContent = s; }

function updateTel(fields){
  const g = k => fields[k];
  document.getElementById('sats').textContent = g('sats') ?? '--';
  document.getElementById('hdop').textContent = g('hdop') ?? '--';
  document.getElementById('alt').textContent  = g('alt') ?? '--';
  document.getElementById('spd').textContent  = g('spd') ?? '--';
  document.getElementById('cog').textContent  = g('cog') ?? '--';
  document.getElementById('dist').textContent = g('dist') ?? '--';
  document.getElementById('brg').textContent  = g('brg') ?? '--';
  document.getElementById('pos').textContent  = `lat=${g('lat') ?? '--'} lon=${g('lon') ?? '--'}`;

  const fix = (g('fix')|0) === 1;
  const tgt = (g('tgt')|0) === 1;
  document.getElementById('fix').innerHTML = fix
    ? '<span class="pill ok">FIX</span>' : '<span class="pill bad">NO FIX</span>';
  document.getElementById('tgt').innerHTML = tgt
    ? '<span class="pill ok">ON</span>'  : '<span class="pill bad">OFF</span>';
}

// parse "TEL key=val key=val ..."
function parseTEL(line){
  const out = {};
  const m = line.match(/(\w+)=([^\s]+)/g);
  if (!m) return out;
  m.forEach(kv=>{
    const [k,v] = kv.split('=');
    out[k] = isNaN(v) ? v : Number(v);
  });
  return out;
}

async function connect(){
  try{
    device = await navigator.bluetooth.requestDevice({
      filters:[{services:[NUS_SERVICE]}]
    });
    device.addEventListener('gattserverdisconnected', ()=>setConnState('disconnected'));
    server = await device.gatt.connect();
    setConnState('connected');
    // MTU: Chrome сам запрашивает максимум; ESP32 обычно ок.
    svc = await server.getPrimaryService(NUS_SERVICE);
    rx = await svc.getCharacteristic(NUS_RX_CHAR);
    tx = await svc.getCharacteristic(NUS_TX_CHAR);
    await tx.startNotifications();
    tx.addEventListener('characteristicvaluechanged', ev=>{
      const s = new TextDecoder().decode(ev.target.value);
      log(s.trim());
      if (s.startsWith('TEL ')) updateTel(parseTEL(s));
    });
    send('GET'); // запросим первый срез
  }catch(e){
    log('ERROR: '+e);
    setConnState('disconnected');
  }
}
function send(s){
  if (!rx) return;
  const data = new TextEncoder().encode(s+'\n');
  rx.writeValue(data);
}

// UI hooks
document.getElementById('btnConnect').addEventListener('click', connect);
document.getElementById('btnSet').addEventListener('click', ()=>{
  const la = (document.getElementById('tLat').value||'').trim();
  const lo = (document.getElementById('tLon').value||'').trim();
  if(!la || !lo) return;
  send(`SET TARGET ${la} ${lo}`);
});
document.getElementById('btnClear').addEventListener('click', ()=>send('CLEAR TARGET'));
document.getElementById('btnGet').addEventListener('click', ()=>send('GET'));
document.getElementById('btnR500').addEventListener('click', ()=>send('RATE 500'));
document.getElementById('btnR1000').addEventListener('click', ()=>send('RATE 1000'));
</script>
</body>
</html>
